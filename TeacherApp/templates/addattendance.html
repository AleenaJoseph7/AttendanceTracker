{% extends 'index.html' %}
{% load static %}
{% block content %}

<div class="container mt-5">

    <h3 class="text-center mb-4" style="font-size:30px; font-weight:bold; color:darkblue;">
        Add Attendance
    </h3>

    <!-- SUBJECT + DATE + LOAD BUTTON -->
    <form method="get" class="mb-4">

        <!-- SUBJECT DROPDOWN ROW -->
        <div class="row justify-content-center mb-3">
            <div class="col-md-6">
                <select name="subject" class="form-select" onchange="this.form.submit()">
                    <option value="">-- Select Subject --</option>
                    {% for s in subjects %}
                    <option value="{{ s.id }}"
                        {% if selected_subject == s.id|stringformat:"s" %}selected{% endif %}>
                        {{ s.Subject_name }} ({{ s.Subject_code }})
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- DATE PICKER + LOAD BUTTON IN SAME ROW -->
        {% if selected_subject %}
        <div class="row justify-content-center" style="display:flex; gap:20px; margin-left:720px;">

            <!-- DATE PICKER (LEFT) -->
            <div class="col-md-3" >
                <input type="date"
                       name="date"
                       class="form-control"
                       value="{{ selected_date }}">
            </div>

            <!-- LOAD BUTTON (RIGHT) -->
            <div class="col-md-3 text-end">
                <button class="btn btn-primary" style="width:150px; height:45px; font-size:16px;">Load</button>
            </div>

        </div>
        {% endif %}

    </form>



    <!-- ATTENDANCE TABLE -->
    {% if sheet %}
    <table class="table table-bordered text-center mt-3">
        <thead class="table-dark">
        <tr>
            <th style="text-align:left;">Student Name</th>
            <th>Subject Code</th>
            <th>Date</th>
            <th>Status (Click to Change)</th>
        </tr>
        </thead>

        <tbody>
        {% for r in sheet %}
        <tr style="text-align:left;">
            <td>{{ r.Student.Student_name }}</td>
            <td>{{ r.Subject.Subject_code }}</td>
            <td>{{ r.Date }}</td>

            <td style="text-align:justify; padding-left:70px;">
                <button class="btn toggle-btn"
                        data-url="{% url 'toggle_attendance' r.id %}"
                        style="font-size:24px;
                               color:{% if r.Status == 'Present' %}green{% else %}red{% endif %};
                               border:none;">

                    {% if r.Status == "Present" %}
                    ✔
                    {% else %}
                    ❌
                    {% endif %}
                </button>
            </td>
        </tr>
        {% endfor %}
        </tbody>

    </table>
    {% endif %}
</div>


<!-- TOGGLE SCRIPT -->
<script>
    document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            let url = btn.getAttribute("data-url");

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "Present") {
                        btn.innerHTML = "✔";
                        btn.style.color = "green";
                    } else {
                        btn.innerHTML = "❌";
                        btn.style.color = "red";
                    }
                });
        });
    });
</script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

{% if messages %}
    {% for i in messages %}
        {% if 'success' in i.tags %}
            <script> swal('{{i}}', '', 'success'); </script>

        {% elif 'warning' in i.tags %}
            <script> swal('{{i}}', '', 'warning'); </script>

        {% elif 'info' in i.tags %}
            <script> swal('{{i}}', '', 'info'); </script>

        {% elif 'error' in i.tags %}
            <script> swal('{{i}}', '', 'error'); </script>

        {% endif %}
    {% endfor %}
{% endif %}
{% endblock %}
