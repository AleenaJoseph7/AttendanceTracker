{% extends 'index.html' %}
{% load static %}
{% block content %}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">

            <div class="card shadow-lg p-4" style="border:1px solid lightgrey; border-radius:10px;">
                <h3 class="text-center mb-4"
                    style="font-size:30px; font-family:Arial; font-weight:bold; color:darkblue;">
                    Edit Student
                </h3>

                <form method="POST" enctype="multipart/form-data"
                      action="{% url 'updatestudent' s_id=student.id %}"
                      name="myform" onsubmit="return validation()">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label class="form-label">Student Name</label>
                        <input type="text" name="student_name" class="form-control"
                               value="{{student.Student_name}}"
                               onkeyup="validateName()">
                        <small class="text-danger" id="err_name"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Roll Number</label>
                        <input type="text" name="student_rollno" class="form-control"
                               value="{{student.Student_rollno}}"
                               onkeyup="validateRoll()">
                        <small class="text-danger" id="err_roll"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Register Number</label>
                        <input type="text" name="student_regid" class="form-control"
                               value="{{student.Student_regid}}"
                               onkeyup="validateReg()">
                        <small class="text-danger" id="err_reg"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Batch</label>
                        <select name="student_batch" class="form-control"
                                onchange="validateBatch()">
                            <option value="">-- Select Batch --</option>
                            <option value="CSE" {% if student.Student_batch==
                            "CSE" %}selected{% endif %}>CSE</option>
                            <option value="EC" {% if student.Student_batch==
                            "EC" %}selected{% endif %}>EC</option>
                            <option value="EEE" {% if student.Student_batch==
                            "EEE" %}selected{% endif %}>EEE</option>
                            <option value="CE" {% if student.Student_batch==
                            "CE" %}selected{% endif %}>CE</option>
                        </select>
                        <small class="text-danger" id="err_batch"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Semester</label>
                        <select name="student_sem" class="form-control"
                                onchange="validateSem()">
                            <option value="">-- Select Semester --</option>
                            <option value="S1" {% if student.Student_sem==
                            "S1" %}selected{% endif %}>S1</option>
                            <option value="S2" {% if student.Student_sem==
                            "S2" %}selected{% endif %}>S2</option>
                            <option value="S3" {% if student.Student_sem==
                            "S3" %}selected{% endif %}>S3</option>
                            <option value="S4" {% if student.Student_sem==
                            "S4" %}selected{% endif %}>S4</option>
                            <option value="S5" {% if student.Student_sem==
                            "S5" %}selected{% endif %}>S5</option>
                            <option value="S6" {% if student.Student_sem==
                            "S6" %}selected{% endif %}>S6</option>
                        </select>
                        <small class="text-danger" id="err_sem"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Duration</label>
                        <input type="text" name="student_duration" class="form-control"
                               value="{{student.Student_duration}}"
                               onkeyup="validateDuration()">
                        <small class="text-danger" id="err_duration"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Mobile Number</label>
                        <input type="text" name="student_phone" class="form-control"
                               value="{{student.Student_phone}}"
                               onkeyup="validatePhone()">
                        <small class="text-danger" id="err_phone"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Email Id</label>
                        <input type="email" name="student_email" class="form-control"
                               value="{{student.Student_email}}"
                               onkeyup="validateEmail()">
                        <small class="text-danger" id="err_email"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="text" name="student_password" class="form-control"
                               value="{{student.Student_password}}"
                               onkeyup="validatePassword()">
                        <small class="text-danger" id="err_pwd"></small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Confirm Password</label>
                        <input type="text" name="student_confirm" class="form-control"
                               value="{{student.Student_confirm}}"
                               onkeyup="validateConfirm()">
                        <small class="text-danger" id="err_confirm"></small>
                    </div>

                    <div class="mb-3">
                        <img src="{{student.Student_prof.url}}" height="120px" width="200px">
                        <input type="file" name="student_prof" class="form-control mt-2">
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary mt-3"
                                style="width:95%; border-radius:10px;">
                            Update Student
                        </button>
                    </div>

                </form>
            </div>

        </div>
    </div>
</div>

<!-- ONLY JS ADDED -->
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const err_name = document.getElementById("err_name");
        const err_roll = document.getElementById("err_roll");
        const err_reg = document.getElementById("err_reg");
        const err_batch = document.getElementById("err_batch");
        const err_sem = document.getElementById("err_sem");
        const err_duration = document.getElementById("err_duration");
        const err_phone = document.getElementById("err_phone");
        const err_email = document.getElementById("err_email");
        const err_pwd = document.getElementById("err_pwd");
        const err_confirm = document.getElementById("err_confirm");

        window.validateName = function () {
            err_name.innerHTML =
                /^[A-Z][A-Za-z]*(?:\s(?:[A-Z][A-Za-z]*|[A-Z](?:\.[A-Z])+))+$/
                    .test(myform.student_name.value.trim())
                    ? ""
                    : "Enter a valid Student Name (eg: Anu M.K or Anu Joseph)";
        };

        window.validateRoll = function () {
            err_roll.innerHTML =
                /^(?:[1-9][0-9]?|100)$/.test(myform.student_rollno.value.trim())
                    ? ""
                    : "Enter a valid Roll Number (1â€“100)";
        };

         window.validateReg = function () {
            const val = myform.student_regid.value.trim();

            if (!/^[A-Z]{3}\d{2}[A-Z]{2}\d{3}$/.test(val)) {
                err_reg.innerHTML = "Enter a valid Register Id (eg :AEC27EC001)";
                return;
            }

            uniqueCheck("student", "regid", val, "err_reg", "This Register Id already exists...!");
         };

        window.validateBatch = function () {
            err_batch.innerHTML =
                myform.student_batch.value === ""
                    ? "Please select a Batch"
                    : "";
        };

        window.validateSem = function () {
            err_sem.innerHTML =
                myform.student_sem.value === ""
                    ? "Please select a Semester"
                    : "";
        };

        window.validateDuration = function () {
            err_duration.innerHTML =
                /^\d{4}-\d{4}$/.test(myform.student_duration.value.trim())
                    ? ""
                    : "Enter duration in the format YYYY-YYYY";
        };

         window.validatePhone = function () {
            const val = myform.student_phone.value.trim();

            if (!/^[6-9]\d{9}$/.test(val)) {
                err_phone.innerHTML = "Enter a valid 10-digit Mobile Number";
                return;
            }

            uniqueCheck("student", "phone", val, "err_phone", "This Mobile Number already exists...!");
        };


       window.validateEmail = function () {
            const val = myform.student_email.value.trim();

            if (!/^[a-z0-9._]+@gmail\.com$/.test(val)) {
                err_email.innerHTML = "Enter a valid Gmail address (example@gmail.com)";
                return;
            }

            uniqueCheck("student", "email", val, "err_email", "This Email Id already exists...!");
        };

        window.validatePassword = function () {
            err_pwd.innerHTML =
                /^(?=.{6,}$)[A-Z](?:[a-z0-9]*[_$#@][a-z0-9]*|[_$#@][a-z0-9]*)$/
                    .test(myform.student_password.value)
                    ? ""
                    : "Password must start with one uppercase letter, include exactly one special character (_,$,#,@), and be at least 6 characters long";
        };

        window.validateConfirm = function () {
            err_confirm.innerHTML =
                myform.student_password.value === myform.student_confirm.value
                    ? ""
                    : "Password and Confirm Password do not match";
        };

        window.validation = function () {
            validateName();
            validateRoll();
            validateReg();
            validateBatch();
            validateSem();
            validateDuration();
            validatePhone();
            validateEmail();
            validatePassword();
            validateConfirm();

            return document.querySelectorAll(".text-danger:not(:empty)").length === 0;
        };

    });
</script>


<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

{% if messages %}
{% for i in messages %}
{% if 'success' in i.tags %}
<script>
    swal('{{i}}', '', 'success');
</script>
{% elif 'warning' in i.tags %}
<script>
    swal('{{i}}', '', 'warning');
</script>
{% elif 'info' in i.tags %}
<script>
    swal('{{i}}', '', 'info');
</script>
{% elif 'error' in i.tags %}
<script>
    swal('{{i}}', '', 'error');
</script>
{% endif %}
{% endfor %}
{% endif %}

{% endblock %}

<script>
    async function uniqueCheck(model, field, value, errId, msg) {
        value = value.trim();
        if (!value) return;

        const res = await fetch("{% url 'uniquecheck' %}?model=" + model +
            "&field=" + field + "&value=" + encodeURIComponent(value));

        const data = await res.json();
        document.getElementById(errId).innerHTML = data.exists ? msg : "";
    }
</script>

